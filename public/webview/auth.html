<!DOCTYPE html>
<html>

<head>
  <title>Auth Helper</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <style>
    /* Keep the reCAPTCHA container off-screen while still present in the DOM */
    #recaptcha-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 1px;
      height: 1px;
      opacity: 0.01; /* tiny but present so invisible challenge can render when required */
      z-index: 9999;
    }
  </style>
</head>

<body>
  <h1>Hello</h1>
  <div id="recaptcha-container"></div>
  <script>
    // firebaseConfig is injected by the React Native wrapper.
    const post = (payload) => window.ReactNativeWebView.postMessage(JSON.stringify(payload));
    const log = (message) => post({ type: 'log', message });
    // Early ping so host knows the WebView booted, even if init fails.
    post({ type: 'ready' });
    log('Auth WebView script loaded');

    let appInitialized = false;
    const ensureApp = () => {
      if (appInitialized) return;
      try {
        firebase.initializeApp(firebaseConfig);
        appInitialized = true;
        log('Auth WebView initialized');
        post({ type: 'ready' });
      } catch (err) {
        post({ type: 'authError', message: err?.message || 'Auth init failed' });
      }
    };

    const getVerifier = () => {
      if (!window.recaptchaVerifier) {
        window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
          size: 'invisible',
          'callback': (token) => log(`reCAPTCHA completed: ${token ? 'token received' : 'no token'}`),
          'expired-callback': () => log('reCAPTCHA expired; resetting'),
        });
      }
      return window.recaptchaVerifier;
    };

    const startPhoneAuth = async (phoneNumber) => {
      try {
        ensureApp();
        const verifier = getVerifier();
        post({ type: 'log', message: `Starting phone auth for ${phoneNumber}` });
        // Trigger the invisible challenge if required
        try {
          await verifier.verify();
        } catch (verifyErr) {
          post({ type: 'log', message: `reCAPTCHA verify failed: ${verifyErr?.message || verifyErr}` });
          throw verifyErr;
        }
        const confirmationResult = await firebase.auth().signInWithPhoneNumber(phoneNumber, verifier);
        post({ type: 'log', message: `Sent verification code to ${phoneNumber}. Got result ${confirmationResult}` });
        post({ type: 'verificationId', verificationId: confirmationResult.verificationId });
      } catch (error) {
        post({ type: 'log', message: `Phone auth error: ${error?.message || error}` });
        post({ type: 'authError', message: error?.message || 'Unknown error' });
        try {
          window.recaptchaVerifier?.clear();
          window.recaptchaVerifier = null;
        } catch (e) { }
      }
    };

    window.addEventListener('message', (event) => {
      try {
        const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
        if (data?.type === 'startPhoneAuth' && data.phoneNumber) {
          startPhoneAuth(data.phoneNumber);
        }
      } catch (error) {
        post({ type: 'authError', message: error?.message || 'Invalid message' });
      }
    });

    // Signal readiness on load
    ensureApp();
  </script>
</body>

</html>
